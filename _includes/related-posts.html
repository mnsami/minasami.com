{% if page.layout == "post" %}
{% assign maxRelated = 3 %}
{% assign minCommonTags = 1 %}
{% assign maxRelatedCounter = 0 %}

{% for post in site.posts %}
  {% assign sameTagCount = 0 %}
  {% assign commonTags = '' %}

  {% for tag in post.tags %}
    {% if post.url != page.url %}
      {% if page.tags contains tag %}
        {% assign sameTagCount = sameTagCount | plus: 1 %}
        {% capture tagmarkup %} <span class="badge bg-secondary">{{ tag }}</span> {% endcapture %}
        {% assign commonTags = commonTags | append: tagmarkup %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if sameTagCount >= minCommonTags %}
    {% unless posts_found contains post.url %}
      <div class="card mb-3">
        <div class="card-body">
          <h5 class="card-title">
            <a href="{{ post.url | relative_url }}">{{ post.title }}</a>
          </h5>
          <p class="card-text">
            <small class="text-muted">{{ post.date | date: "%b %-d, %Y" }}</small>
          </p>
          {% if post.description %}
          <p class="card-text">{{ post.description | truncate: 120 }}</p>
          {% elsif post.excerpt %}
          <p class="card-text">{{ post.excerpt | strip_html | truncate: 120 }}</p>
          {% endif %}
          <p class="card-text">
            <small>Common tags: {{ commonTags }}</small>
          </p>
        </div>
      </div>
      {% assign maxRelatedCounter = maxRelatedCounter | plus: 1 %}
      {% if maxRelatedCounter >= maxRelated %}
        {% break %}
      {% endif %}
      {% capture posts_found %}{{ posts_found }}{{ post.url }}{% endcapture %}
    {% endunless %}
  {% endif %}
{% endfor %}
{% endif %}
